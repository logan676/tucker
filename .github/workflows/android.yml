name: Android CI/CD

on:
  push:
    branches: [main, develop]
    paths:
      - 'apps/android-customer/**'
      - 'apps/android-merchant/**'
      - '.github/workflows/android.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'apps/android-customer/**'
      - 'apps/android-merchant/**'

jobs:
  build-customer:
    name: Build Android Customer
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: 8.4

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-customer-${{ hashFiles('apps/android-customer/**/*.gradle*', 'apps/android-customer/**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-customer-

      - name: Grant execute permission
        run: chmod +x apps/android-customer/gradlew

      - name: Run Lint
        run: |
          cd apps/android-customer
          ./gradlew lint

      - name: Run unit tests
        run: |
          cd apps/android-customer
          ./gradlew test

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: android-customer-test-results
          path: apps/android-customer/app/build/reports/tests

      - name: Build Debug APK
        run: |
          cd apps/android-customer
          ./gradlew assembleDebug

      - name: Upload Debug APK
        uses: actions/upload-artifact@v3
        with:
          name: android-customer-debug-apk
          path: apps/android-customer/app/build/outputs/apk/debug/*.apk

  build-merchant:
    name: Build Android Merchant
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: 8.4

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-merchant-${{ hashFiles('apps/android-merchant/**/*.gradle*', 'apps/android-merchant/**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-merchant-

      - name: Grant execute permission
        run: chmod +x apps/android-merchant/gradlew

      - name: Run Lint
        run: |
          cd apps/android-merchant
          ./gradlew lint

      - name: Run unit tests
        run: |
          cd apps/android-merchant
          ./gradlew test

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: android-merchant-test-results
          path: apps/android-merchant/app/build/reports/tests

      - name: Build Debug APK
        run: |
          cd apps/android-merchant
          ./gradlew assembleDebug

      - name: Upload Debug APK
        uses: actions/upload-artifact@v3
        with:
          name: android-merchant-debug-apk
          path: apps/android-merchant/app/build/outputs/apk/debug/*.apk

  instrumented-tests:
    name: Android Instrumented Tests
    runs-on: ubuntu-latest
    needs: [build-customer, build-merchant]
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Run instrumented tests (Customer)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          target: google_apis
          arch: x86_64
          working-directory: apps/android-customer
          script: ./gradlew connectedAndroidTest

  release-customer:
    name: Release Android Customer
    runs-on: ubuntu-latest
    needs: [build-customer, instrumented-tests]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Decode keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 --decode > apps/android-customer/keystore.jks

      - name: Build Release AAB
        env:
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          cd apps/android-customer
          ./gradlew bundleRelease \
            -Pandroid.injected.signing.store.file=keystore.jks \
            -Pandroid.injected.signing.store.password="$KEYSTORE_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$KEY_PASSWORD"

      - name: Upload to Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}
          packageName: com.tucker.customer
          releaseFiles: apps/android-customer/app/build/outputs/bundle/release/*.aab
          track: internal
          status: completed

  release-merchant:
    name: Release Android Merchant
    runs-on: ubuntu-latest
    needs: [build-merchant, instrumented-tests]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Decode keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_MERCHANT_KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 --decode > apps/android-merchant/keystore.jks

      - name: Build Release AAB
        env:
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_MERCHANT_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_MERCHANT_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_MERCHANT_KEY_PASSWORD }}
        run: |
          cd apps/android-merchant
          ./gradlew bundleRelease \
            -Pandroid.injected.signing.store.file=keystore.jks \
            -Pandroid.injected.signing.store.password="$KEYSTORE_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$KEY_PASSWORD"

      - name: Upload to Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}
          packageName: com.tucker.merchant
          releaseFiles: apps/android-merchant/app/build/outputs/bundle/release/*.aab
          track: internal
          status: completed
